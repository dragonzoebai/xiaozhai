<!doctype html>
<html lang="en">
	<head>
		<title>小寨管线特效线</title>
		<link rel="stylesheet"
			href="https://cdn.jsdelivr.net/gh/openlayers/openlayers.github.io@master/en/v6.4.3/css/ol.css"
			type="text/css">
		<style>
			html,
			body,
			.map {
				height: 100%;
				width: 100%;
				margin: 0;
				padding: 0
			}
		</style>
	</head>
	<body>
		<div id="map" class="map"></div>
	</body>
	<script src="https://cdn.jsdelivr.net/gh/openlayers/openlayers.github.io@master/en/v6.4.3/build/ol.js"></script>
	<script src="https://cdn.jsdelivr.net/npm/echarts@4.9.0/dist/echarts.min.js"></script>
	<script src="https://cdn.jsdelivr.net/npm/ol3-echarts@2.0.3/dist/ol3Echarts.min.js"></script>
	<script src="https://cdn.bootcdn.net/ajax/libs/jquery/3.5.1/jquery.min.js"></script>
	<script type="text/javascript">
		var basePath = 'https://xz.csceccloud.net:10000/arcgis/rest'
		var urlTile = basePath + '/services/xiaozhaimap_dark/MapServer';
		var serviceUrlPipeNetwork = basePath + '/services/xiaozha/mx_pipe_network_properties/MapServer/0/query'
		var osmLayer = new ol.layer.Tile({
			source: new ol.source.OSM(),
		});
		var imageLayer = new ol.layer.Image({
			source: new ol.source.ImageArcGISRest({
				url: urlTile,
			}),
		});
		var tileLayer = new ol.layer.Tile({
			source: new ol.source.TileArcGISRest({
				url: urlTile,
			}),
		});
		var xyzLayer = new ol.layer.Tile({
			source: new ol.source.XYZ({
				url: urlTile + '/tile/{z}/{y}/{x}'
			})
		});
		/**
		 * 高德底图
		 */
		var gaodeMapLayer = new ol.layer.Tile({
			source: new ol.source.XYZ({
				url: 'http://t0.tianditu.com/vec_w/wmts?service=wmts&request=GetTile&version=1.0.0&LAYER=vec&tileMatrixSet=w&TileMatrix={z}&TileRow={y}&TileCol={x}&style=default&format=tiles&tk=40b190683706230fade806c1ac8c14e8'
				// url: 'http://wprd0{1-4}.is.autonavi.com/appmaptile?lang=zh_cn&size=1&scl=2&style=7&x={x}&y={y}&z={z}'
			}),
			visible: true
		});


		// 管线数据
		var stylePipeNetwork = {
			'1': new ol.style.Style({
				stroke: new ol.style.Stroke({
					color: 'rgba(255, 0, 0, 1)',
					width: 3,
				}),
			}),
			'2': new ol.style.Style({
				stroke: new ol.style.Stroke({
					color: 'rgba(0, 255, 0, 1)',
					width: 3,
				}),
			}),
			'3': new ol.style.Style({
				stroke: new ol.style.Stroke({
					color: 'rgba(255, 255, 0,  1)',
					width: 3,
				}),
			})
		};
		
		/**
		var vectorSourcePipeNetwork = new ol.source.Vector({
			format: new ol.format.EsriJSON(),
			url: (extent) => {
				return (
					serviceUrlPipeNetwork +
					'?f=json&returnGeometry=true&spatialRel=esriSpatialRelIntersects&geometry=' +
					encodeURIComponent(
						'{"xmin":' +
						extent[0] +
						',"ymin":' +
						extent[1] +
						',"xmax":' +
						extent[2] +
						',"ymax":' +
						extent[3] +
						',"spatialReference":{"wkid":102100}}'
					) +
					'&geometryType=esriGeometryEnvelope&inSR=102100&outFields=*' +
					'&outSR=102100'
				);
			},
			strategy: ol.loadingstrategy.bbox
		});
		**/
		
		var vectorSourcePipeNetwork = new ol.source.Vector({
			format: new ol.format.GeoJSON(),
			url: './status_link.json'
		});

		var vectorLayerPipeNetwork = new ol.layer.Vector({
			minZoom: 12,
			// maxZoom: 17,
			source: vectorSourcePipeNetwork,
			style: (feature)=> {
				// console.log(feature.get('NetTypeNo'))
				var classify = feature.get('NetTypeNo');
				return stylePipeNetwork[classify];
			},
		});

		var layers = [
			// gaodeMapLayer,
			// osmLayer,
			// imageLayer,
			// tileLayer,
			xyzLayer,
			// vectorLayerPipeNetwork
		];

		var map = new ol.Map({
			target: 'map',
			layers: layers,
			view: new ol.View({
				center: transform([108.948301, 34.223445]),
				// center: [108.948301, 34.223445],
				// projection: 'EPSG:4326',
				zoom: 15
			})
		});
		
		function transform(pois){
			return ol.proj.transform(pois, 'EPSG:4326', 'EPSG:3857')
		}
		
		/**
		 * 特效线
		 */
		var echartslayer = new ol3Echarts(null, {
			hideOnMoving: true,
			hideOnZooming: true
		});
		echartslayer.appendTo(map);
		// var url = 'https://xz.csceccloud.net:10000/arcgis/rest/services/xiaozha/mx_pipe_network_properties/MapServer/0/query?where=1%3D1&text=&objectIds=&time=&geometry=&geometryType=esriGeometryEnvelope&inSR=&spatialRel=esriSpatialRelIntersects&relationParam=&outFields=*&returnGeometry=true&returnTrueCurves=false&maxAllowableOffset=&geometryPrecision=&outSR=&having=&returnIdsOnly=false&returnCountOnly=false&orderByFields=&groupByFieldsForStatistics=&outStatistics=&returnZ=false&returnM=false&gdbVersion=&historicMoment=&returnDistinctValues=false&resultOffset=&resultRecordCount=&queryByDistance=&returnExtentOnly=false&datumTransformation=&parameterValues=&rangeValues=&quantizationParameters=&f=geojson'
		$.get('./status_link.json', (data)=> {
			var busLines = []
			data.features.forEach(e=>{
				var colorStr = 'rgba(255, 0, 0, 1.0)';
				var NetTypeNo = e.properties.NetTypeNo;
				if(NetTypeNo==1){
					colorStr = 'rgba(255, 0, 0, 1)';
				}else if(NetTypeNo==2){
					colorStr = 'rgba(0, 255, 0, 1)';
				}else if(NetTypeNo==3){
					colorStr = 'rgba(255, 255, 0,  1)';
				}
				busLines.push({
					coords: e.geometry.coordinates,
					lineStyle: {
						normal: {
							color: colorStr
						}
					}
				})
			})
			echartsOption = {
				series: [
					// 实线
					{
						type: 'lines',
						polyline: true,
						data: busLines,
						silent: true,
						lineStyle: {
							normal: {
								opacity: 0.5,
								width: 2
							}
						},
						progressiveThreshold: 500,
						progressive: 200,
						zlevel: 2
					},
					// 拖影
					{
						type: 'lines',
						polyline: true,
						data: busLines,
						lineStyle: {
							normal: {
								width: 0
							}
						},
						effect: {
							constantSpeed: 20,
							show: true,
							trailLength: 0.3,
							symbolSize: 3
						},
						zlevel: 1
					}]
			};
			echartslayer.setChartOptions(echartsOption);
		});
	</script>
</html>
