<!doctype html>
<html lang="en">
	<head>
		<title>活水路线</title>
		<link rel="stylesheet"
			href="https://cdn.jsdelivr.net/gh/openlayers/openlayers.github.io@master/en/v6.4.3/css/ol.css"
			type="text/css">
		<style>
			html,
			body,
			.map {
				height: 100%;
				width: 100%;
				margin: 0;
				padding: 0
			}
		</style>
	</head>
	<body>
		<div id="map" class="map"></div>
	</body>
	<script src="https://cdn.jsdelivr.net/gh/openlayers/openlayers.github.io@master/en/v6.4.3/build/ol.js"></script>
	<script src="https://cdn.jsdelivr.net/npm/echarts@4.9.0/dist/echarts.min.js"></script>
	<script src="https://cdn.jsdelivr.net/npm/ol3-echarts@2.0.3/dist/ol3Echarts.min.js"></script>
	<script src="https://cdn.bootcdn.net/ajax/libs/jquery/3.5.1/jquery.min.js"></script>
	<script type="text/javascript">
		var basePath = 'https://xz.csceccloud.net:10000/arcgis/rest'
		var urlTile = basePath + '/services/xiaozhaimap_light/MapServer';
		var serviceUrlPipeNetwork = basePath + '/services/xiaozha/mx_pipe_network_properties/MapServer/0/query'
		var osmLayer = new ol.layer.Tile({
			source: new ol.source.OSM(),
		});
		var imageLayer = new ol.layer.Image({
			source: new ol.source.ImageArcGISRest({
				url: urlTile,
			}),
		});
		var tileLayer = new ol.layer.Tile({
			source: new ol.source.TileArcGISRest({
				url: urlTile,
			}),
		});
		var xyzLayer = new ol.layer.Tile({
			source: new ol.source.XYZ({
				url: urlTile + '/tile/{z}/{y}/{x}'
			})
		});
		/**
		 * 高德底图
		 */
		var gaodeMapLayer = new ol.layer.Tile({
			source: new ol.source.XYZ({
				url: 'http://t0.tianditu.com/vec_w/wmts?service=wmts&request=GetTile&version=1.0.0&LAYER=vec&tileMatrixSet=w&TileMatrix={z}&TileRow={y}&TileCol={x}&style=default&format=tiles&tk=40b190683706230fade806c1ac8c14e8'
				// url: 'http://wprd0{1-4}.is.autonavi.com/appmaptile?lang=zh_cn&size=1&scl=2&style=7&x={x}&y={y}&z={z}'
			}),
			visible: true
		});
		
		var vectorSourcePoints = new ol.source.Vector({
			format: new ol.format.GeoJSON(),
			url: './points.geojson'
		});
		
		var vectorLayerPoints = new ol.layer.Vector({
			minZoom: 12,
			// maxZoom: 17,
			source: vectorSourcePoints,
			style: styleFuncNode,
		});
		
		function styleFuncNode(feature) {
			var imgSrc = './node_blue.gif';
			var style = new ol.style.Style({
				image: new ol.style.Icon({
					scale: 0.8,
					anchor: [0.5, 0.5],
					src: imgSrc, //图标路径
					rotation: 0 //旋转角度
				})
			});
			return style;
		}
		
		
		var layers = [
			// gaodeMapLayer,
			// osmLayer,
			// imageLayer,
			// tileLayer,
			xyzLayer,
			vectorLayerPoints
		];

		var map = new ol.Map({
			target: 'map',
			layers: layers,
			view: new ol.View({
				center: transform([108.948301, 34.223445]),
				// center: [108.948301, 34.223445],
				// projection: 'EPSG:4326',
				zoom: 15
			})
		});
		
		function transform(pois){
			return ol.proj.transform(pois, 'EPSG:4326', 'EPSG:3857')
		}
		
		/**
		 * 特效线
		 */
		var echartslayer = new ol3Echarts(null, {
			hideOnMoving: true,
			hideOnZooming: true
		});
		echartslayer.appendTo(map);
		// var url = 'https://xz.csceccloud.net:10000/arcgis/rest/services/xiaozha/mx_pipe_network_properties/MapServer/0/query?where=1%3D1&text=&objectIds=&time=&geometry=&geometryType=esriGeometryEnvelope&inSR=&spatialRel=esriSpatialRelIntersects&relationParam=&outFields=*&returnGeometry=true&returnTrueCurves=false&maxAllowableOffset=&geometryPrecision=&outSR=&having=&returnIdsOnly=false&returnCountOnly=false&orderByFields=&groupByFieldsForStatistics=&outStatistics=&returnZ=false&returnM=false&gdbVersion=&historicMoment=&returnDistinctValues=false&resultOffset=&resultRecordCount=&queryByDistance=&returnExtentOnly=false&datumTransformation=&parameterValues=&rangeValues=&quantizationParameters=&f=geojson'
		$.getJSON('./line.geojson', (data)=> {
			var busLines = []
			var busLines1 = []
			data.features.forEach(e=>{
				busLines.push({
					coords: e.geometry.coordinates,
					lineStyle: {
						normal: {
							color: 'rgba(0, 255, 0, 1)'
						}
					}
				})
				busLines1.push({
					coords: e.geometry.coordinates,
					lineStyle: {
						normal: {
							color: '#38D7FF'
						}
					}
				})
			})
			echartsOption = {
				series: [
					// 实线
					{
						type: 'lines',
						polyline: true,
						data: busLines,
						silent: true,
						lineStyle: {
							normal: {
								opacity: 0.5,
								width: 8
							}
						},
						progressiveThreshold: 500,
						progressive: 200,
						zlevel: 2
					},
					// 拖影
					{
						type: 'lines',
						polyline: true,
						data: busLines1,
						lineStyle: {
							normal: {
								width: 0
							}
						},
						effect: {
							constantSpeed: 20,
							show: true,
							trailLength: 0.5,
							symbolSize: 8
						},
						zlevel: 3
					}]
			};
			echartslayer.setChartOptions(echartsOption);
		});
	</script>
</html>
