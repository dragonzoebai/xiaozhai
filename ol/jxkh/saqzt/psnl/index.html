<!doctype html>
<html lang="en">
	<head>
		<meta http-equiv="Content-Type" content="text/html; charset=utf-8" />
		<title>排水能力对比</title>
		<link rel="stylesheet" type="text/css"
			href="https://cdn.jsdelivr.net/gh/openlayers/openlayers.github.io@master/en/v6.4.3/css/ol.css">
		<link rel="stylesheet" type="text/css" href="../../common/style.css" />
		<script src="https://cdn.jsdelivr.net/gh/openlayers/openlayers.github.io@master/en/v6.4.3/build/ol.js"></script>
		<script src="https://cdn.bootcdn.net/ajax/libs/jquery/3.5.1/jquery.min.js"></script>
	</head>

	<body>
		<!--地图控件-->
		<div id="map" class="map"></div>
		<!--地图底图切换-->
		<div class="layerswitch">
			<div class="selected col" onclick="layerSwitch(this,'topo')"
				style="background-image: url(../../common/images/topo.jpg);">
				<div class="label">电子</div>
			</div>
			<div class="col" onclick="layerSwitch(this,'hybrid')"
				style="background-image: url(../../common/images/hybrid.jpg);">
				<div class="label">卫星</div>
			</div>
		</div>
		<!--图例展示-->
		<div class="mapLegend" style="display: block;">
			<div class="title">管径充满度</div>
			<div class="item">
				<div class="before square" style="background-color: rgb(255, 0, 0);"></div>
				<div class="label"> = 1</div>
			</div>
			<div class="item">
				<div class="before square" style="background-color: rgb(242, 121, 0);"></div>
				<div class="label">0.8 - 1</div>
			</div>
			<div class="item">
				<div class="before square" style="background-color: rgb(255, 255, 0);"></div>
				<div class="label"> 0.5 - 0.8</div>
			</div>
			<div class="item">
				<div class="before square" style="background-color: rgb(6, 85, 2);"></div>
				<div class="label">0 - 0.5</div>
			</div>
		</div>
		<!--前后对比按钮-->
		<div class="compareButtons">
			<div class="btn selected" onclick="changeData(this,1)">建设前</div>
			<div class="btn" onclick="changeData(this,2)">建设后</div>
		</div>
		<div id="popup" class="ol-popup">
			<a href="#" id="popup-closer" class="ol-popup-closer"></a>
			<div id="popup-content"></div>
		</div>
		
	</body>

	<script>
		var basePath = 'https://xz.csceccloud.net:10000/arcgis/rest'
		var urlTileDLG = basePath + '/services/xiaozhaimap_dark/MapServer'; // MyMapService777、xiaozhaimap_dark
		var urlTileDOM = basePath + '/services/MyMapService990/MapServer';
		var jsonformat = new ol.format.GeoJSON();
		var tileLayer = new ol.layer.Tile({
			source: new ol.source.TileArcGISRest({
				url: urlTileDLG,
			}),
		});

		/**
		 * Elements that make up the popup.
		 */
		var popup_container = document.getElementById('popup');
		var popup_content = document.getElementById('popup-content');
		var popup_closer = document.getElementById('popup-closer');

		/**
		 * Create an overlay to anchor the popup to the map.
		 */
		var popup_overlay = new ol.Overlay({
			element: popup_container,
			autoPan: true,
			autoPanAnimation: {
				duration: 250,
			},
		});

		/**
		 * Add a click handler to hide the popup.
		 * @return {boolean} Don't follow the href.
		 */
		popup_closer.onclick = function() {
			popup_overlay.setPosition(undefined);
			popup_closer.blur();
			return false;
		};

		var stylePipeNetwork = {
			'1': new ol.style.Style({
				stroke: new ol.style.Stroke({
					color: 'rgb(6, 85, 2)',
					width: 3,
				}),
			}),
			'2': new ol.style.Style({
				stroke: new ol.style.Stroke({
					color: 'rgb(255, 255, 0)',
					width: 3,
				}),
			}),
			'3': new ol.style.Style({
				stroke: new ol.style.Stroke({
					color: 'rgb(242, 121, 0)',
					width: 3,
				}),
			}),
			'4': new ol.style.Style({
				stroke: new ol.style.Stroke({
					color: 'rgb(255, 0, 0)',
					width: 3,
				}),
			}),
		};

		function changStyle(feature) {
			var results = feature.get('result');
			if (results > 1) {
				return stylePipeNetwork['4'];
			} else if (results > 0.8) {
				return stylePipeNetwork['3'];
			} else if (results > 0.5) {
				return stylePipeNetwork['2'];
			}
			return stylePipeNetwork['1'];
		}

		var vectorSourcePipeNetwork = new ol.source.Vector({
			format: new ol.format.GeoJSON(),
		});
		var vectorLayerPipeNetwork = new ol.layer.Vector({
			source: vectorSourcePipeNetwork,
			style: changStyle,
		});

		var map = new ol.Map({
			target: 'map',
			// overlays: [popup_overlay],
			controls: ol.control.defaults({
				zoom: false
			}),
			layers: [tileLayer, vectorLayerPipeNetwork],
			view: new ol.View({
				center: transform([108.948301, 34.223445]),
				projection: 'EPSG:3857',
				zoom: 14.5,
			})
		});
		
		function transform(pois) {
			return ol.proj.transform(pois, 'EPSG:4326', 'EPSG:3857')
		}

		map.on('pointermove', (e) => {
			map.forEachFeatureAtPixel(e.pixel, function(feature) {
				if (feature) {
					var type = feature.getGeometry().getType();
					var coordinate = e.coordinate;
					var property = feature.getProperties();
					popup_content.innerHTML = '<code>' + getPopupHtml(type, property) + '</code>';
					popup_overlay.setPosition(coordinate);
				}
			});
		});

		function getPopupHtml(type, pro) {
			var str = "";
			const keys = Object.keys(pro)
			for (let i = 0; i < keys.length; i++) {
				const key = keys[i]
				const value = pro[key]
				str += "<div>" + key + ": <span>" + value + "</span></div>";
			}
			return str;
		}

		vectorSourcePipeNetwork.on('featuresloadend', (obj) => {
			console.log(obj)
		})

		function changeData1(p) {
			vectorSourcePipeNetwork.clear()
			$.getJSON("links3857.geojson", (p1) => {
				$.getJSON(p+"A-FlowVelocity-Link.json", (res) => {
					p1.features.forEach(f => {
						f.properties.result = res[f.properties.MUID];
						var feature = jsonformat.readFeature(f);
						vectorSourcePipeNetwork.addFeature(feature);
					})
				})
			})
		}

		function changeData(obj, p) {
			$(obj).addClass('selected').siblings('div').removeClass('selected');
			changeData1(p)
		}
		changeData(null,1)


		function layerSwitch(obj, style) {
			$(obj).addClass('selected').siblings('div').removeClass('selected');
			if (style == 'topo') {
				tileLayer.getSource().setUrl(urlTileDLG)
			} else if (style == 'hybrid') {
				tileLayer.getSource().setUrl(urlTileDOM)
			}
		}
	</script>

</html>
