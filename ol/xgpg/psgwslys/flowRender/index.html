<!doctype html>
<html lang="en">
	<head>
		<meta http-equiv="Content-Type" content="text/html; charset=utf-8" />
		<!-- <meta name="viewport" content="initial-scale=1.0, user-scalable=no, width=device-width"> -->
		<title>排水管网-流量变化过程</title>
		<link rel="stylesheet"
			href="https://cdn.jsdelivr.net/gh/openlayers/openlayers.github.io@master/en/v6.9.0/css/ol.css"
			type="text/css">
		<style>
			html,
			body,
			.map {
				height: 100%;
				width: 100%;
				margin: 0;
				padding: 0
			}

			.ol-popup {
				position: absolute;
				background-color: white;
				box-shadow: 0 1px 4px rgba(0, 0, 0, 0.2);
				padding: 15px;
				border-radius: 10px;
				border: 1px solid #cccccc;
				bottom: 12px;
				left: -50px;
				min-width: 150px;
			}

			.ol-popup:after,
			.ol-popup:before {
				top: 100%;
				border: solid transparent;
				content: " ";
				height: 0;
				width: 0;
				position: absolute;
				pointer-events: none;
			}

			.ol-popup:after {
				border-top-color: white;
				border-width: 10px;
				left: 48px;
				margin-left: -10px;
			}

			.ol-popup:before {
				border-top-color: #cccccc;
				border-width: 11px;
				left: 48px;
				margin-left: -11px;
			}

			.ol-popup-closer {
				text-decoration: none;
				position: absolute;
				top: 2px;
				right: 8px;
			}

			.ol-popup-closer:after {
				content: "X";
			}

			#popup-content div {
				color: #000;
			}

			#popup-content div span {
				color: #00f;
			}
		</style>
	</head>

	<body>
		<div id="map" class="map"></div>
		<div id="popup" class="ol-popup">
			<a href="#" id="popup-closer" class="ol-popup-closer"></a>
			<div id="popup-content"></div>
		</div>
		<div style="position: absolute;top: 10px;left: 10px;">
			<button onclick="changeData(1)">P1</button>
			<button onclick="changeData(2)">P2</button>
			<button onclick="changeData(3)">P3</button>
			<button onclick="changeData(5)">P5</button>
			<button onclick="changeData(10)">P10</button>
			<button onclick="changeData(20)">P20</button>
			<button onclick="changeData(30)">P30</button>
			<button onclick="changeData(50)">P50</button>
			<span id="spanMarker" style="background-color: #000000;color: #ffffff;"></span>
		</div>
	</body>
	<script src="https://cdn.jsdelivr.net/gh/openlayers/openlayers.github.io@master/en/v6.9.0/build/ol.js"></script>
	<script src="https://cdn.bootcdn.net/ajax/libs/jquery/3.5.1/jquery.min.js"></script>
	<script src="https://cdn.bootcdn.net/ajax/libs/FileSaver.js/2.0.5/FileSaver.min.js"></script>
	<script>
		var basePath = 'https://xz.csceccloud.net:10000/arcgis/rest'
		var urlTile = basePath + '/services/xiaozhaimap_dark/MapServer'; // MyMapService777、xiaozhaimap_dark
		var jsonformat = new ol.format.GeoJSON();
		var gaodeMapLayer = new ol.layer.Tile({
			source: new ol.source.XYZ({
				url: 'http://t0.tianditu.com/vec_w/wmts?service=wmts&request=GetTile&version=1.0.0&LAYER=vec&tileMatrixSet=w&TileMatrix={z}&TileRow={y}&TileCol={x}&style=default&format=tiles&tk=40b190683706230fade806c1ac8c14e8'
				// url: 'http://wprd0{1-4}.is.autonavi.com/appmaptile?lang=zh_cn&size=1&scl=2&style=7&x={x}&y={y}&z={z}'
			}),
			visible: true
		});
		var tileLayer = new ol.layer.Tile({
			source: new ol.source.TileArcGISRest({
				url: urlTile,
			}),
		});

		/**
		 * Elements that make up the popup.
		 */
		var popup_container = document.getElementById('popup');
		var popup_content = document.getElementById('popup-content');
		var popup_closer = document.getElementById('popup-closer');

		/**
		 * Create an overlay to anchor the popup to the map.
		 */
		var popup_overlay = new ol.Overlay({
			element: popup_container,
			autoPan: true,
			autoPanAnimation: {
				duration: 250,
			},
		});

		/**
		 * Add a click handler to hide the popup.
		 * @return {boolean} Don't follow the href.
		 */
		popup_closer.onclick = function() {
			popup_overlay.setPosition(undefined);
			popup_closer.blur();
			return false;
		};

		var stylePipeNetwork = {
			'1': new ol.style.Style({
				stroke: new ol.style.Stroke({
					color: '#008000',
					width: 3,
				}),
			}),
			'2': new ol.style.Style({
				stroke: new ol.style.Stroke({
					color: '#ffff00',
					width: 3,
				}),
			}),
			'3': new ol.style.Style({
				stroke: new ol.style.Stroke({
					color: '#ffad5f',
					width: 3,
				}),
			}),
			'4': new ol.style.Style({
				stroke: new ol.style.Stroke({
					color: '#ff0000',
					width: 3,
				}),
			}),
		};

		function changStyle(feature) {
			var results = feature.get('Value');
			// console.log(results)
			if (results > 0.3) {
				return stylePipeNetwork['4'];
			} else if (results > 0.1) {
				return stylePipeNetwork['2'];
			}
			return stylePipeNetwork['1'];
		}

		var vectorSourcePipeNetwork = new ol.source.Vector({
			format: new ol.format.GeoJSON(),
			url: "../pip.geojson",
		});
		var vectorLayerPipeNetwork = new ol.layer.Vector({
			source: vectorSourcePipeNetwork,
			style: changStyle,
		});

		var map = new ol.Map({
			target: 'map',
			overlays: [popup_overlay],
			controls: ol.control.defaults({
				zoom: false
			}),
			layers: [tileLayer, vectorLayerPipeNetwork], //gaodeMapLayer, tileLayer,
			view: new ol.View({
				center: [108.948301, 34.223445],
				projection: 'EPSG:4326',
				zoom: 14.5,
			})
		});

		function transform(pois) {
			return ol.proj.transform(pois, 'EPSG:4326', 'EPSG:3857')
		}

		//鼠标移动事件singleclick\pointermove
		map.on('pointermove', (e) => {
			map.forEachFeatureAtPixel(e.pixel, function(feature) {
				if (feature) {
					// console.log(feature.getGeometry());
					var type = feature.getGeometry().getType();
					var coordinate = e.coordinate;
					var property = feature.getProperties();
					popup_content.innerHTML = '<code>' + getPopupHtml(type, property) + '</code>';
					popup_overlay.setPosition(coordinate);
					// console.log(property)
				}
			});
		});

		function getPopupHtml(type, pro) {
			var str = "";
			const keys = Object.keys(pro)
			for (let i = 0; i < keys.length; i++) {
				const key = keys[i]
				const value = pro[key]
				str += "<div>" + key + ": <span>" + value + "</span></div>";
			}
			return str;
		}

		var myInterval = null

		function changeData1(p) {
			clearInterval(myInterval)
			$.getJSON(p + "A-FlowVelocity-DT.json", (res) => {
				res = JSON.parse(res)
				var i = 0
				var maxNum = res[Object.keys(res)[0]].TimeSeries.length
				// console.log(maxNum)
				myInterval = setInterval(() => {
					vectorSourcePipeNetwork.getFeatures().forEach(f => {
						var prop = f.getProperties()
						var muid = prop.MUID
						prop.Value = Math.abs(res[muid].TimeSeries[i].Value) * 100
						// console.log(prop.Value)
						f.setProperties(prop)
					})
					i++;
					// console.log(i)
					$("#spanMarker").html("P" + p + " 运行中: " + i + " 帧")
					if (i >= maxNum) {
						clearInterval(myInterval)
						$("#spanMarker").html("结束")
					}
				}, 200)
			})
		}


		function changeData2(p) {
			vectorSourcePipeNetwork.setUrl('./result/pip_flow_render_P' + p + '.json')
			vectorSourcePipeNetwork.refresh()
		}
		vectorSourcePipeNetwork.on('featuresloadend', (obj) => {
			var url = vectorSourcePipeNetwork.getUrl()
			var jsonname = url.substr(url.lastIndexOf("_")+1)
			var level = jsonname.substr(0,jsonname.lastIndexOf('.'))
			
			clearInterval(myInterval)
			var i = 0
			var feature = vectorSourcePipeNetwork.getFeatures()[0];
			if (feature.get('timeseries')) {
				var maxNum = feature.get('timeseries')[0].TimeSeries.length
				myInterval = setInterval(() => {
					vectorSourcePipeNetwork.getFeatures().forEach(f => {
						var prop = f.getProperties()
						var muid = prop.MUID
						prop.Value = Math.abs(prop.timeseries[0].TimeSeries[i].Value) * 100
						// console.log(prop.Value)
						f.setProperties(prop)
					})
					i++;
					// console.log(i)
					$("#spanMarker").html(level+"运行中: " + i + " 帧")
					if (i >= maxNum) {
						clearInterval(myInterval)
						$("#spanMarker").html("结束")
					}
				}, 200)
			}
		})

		function changeData(p) {
			// changeData1(p)
			changeData2(p)
		}


		function mergeData(p) {
			$.getJSON("../pip.geojson", (p1) => {
				$.getJSON({
					url: p + "A-FlowVelocity-DT.json",
					async: false,
					success: (res) => {
						res = JSON.parse(res)
						p1.features.forEach(f => {
							f.properties.timeseries = [res[f.properties.MUID]];
						})
					}
				})
				// console.log(JSON.stringify(p1))
				var blob = new Blob([JSON.stringify(p1)], {
					type: "text/plain;charset=utf-8"
				});
				saveAs(blob, "pip_flow_render_P" + p + ".json");
			})
		}

		var list = [1, 2, 3, 5, 10, 20, 30, 50] //
		list.forEach(p => {
			// mergeData(p)
		})
	</script>

</html>
